<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Here be dragons ‚Ä¢ hmde</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Here be dragons">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">hmde</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/hmde.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><h6 class="dropdown-header" data-toc-skip>Case Studies</h6></li>
    <li><a class="dropdown-item" href="../articles/constant-growth.html">Constant growth model</a></li>
    <li><a class="dropdown-item" href="../articles/von-bertalanffy.html">von Bertalanffy model</a></li>
    <li><a class="dropdown-item" href="../articles/canham.html">Canham model</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/traitecoevo/hmde/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Here be dragons</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/traitecoevo/hmde/blob/master/vignettes/here_be_dragons.Rmd" class="external-link"><code>vignettes/here_be_dragons.Rmd</code></a></small>
      <div class="d-none name"><code>here_be_dragons.Rmd</code></div>
    </div>

    
    
<div class="section level3">
<h3 id="load-dependencies">Load dependencies<a class="anchor" aria-label="anchor" href="#load-dependencies"></a>
</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#remotes::install_github("traitecoevo/hmde")</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://traitecoevo.github.io/hmde/">hmde</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dplyr'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://desolve.r-forge.r-project.org/" class="external-link">deSolve</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/dsy109/mixtools" class="external-link">mixtools</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; mixtools package, version 2.0.0.1, Released 2022-12-04</span></span>
<span><span class="co">#&gt; This package is based upon work supported by the National Science Foundation under Grant No. SES-0518772 and the Chan Zuckerberg Initiative: Essential Open Source Software for Science (Grant No. 2020-255193).</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://www.stats.ox.ac.uk/pub/MASS4/" class="external-link">MASS</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'MASS'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:dplyr':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     select</span></span></code></pre></div>
<p>This vignette demonstrates an interaction between errors from
numerical integration methods and MCMC sampling that produces a bimodal
posterior distribution as a result of numerical error. We stumbled
across the problem and are documenting it here, but account for it in
the package through either using analytic solutions, or numerical
methods with adaptive step sizes where analytic solutions are not
available.</p>
<p>The underlying issue is that if, given errors in the chosen numerical
integration method, two sets of parameters for a differential equation
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>f</mi><annotation encoding="application/x-tex">f</annotation></semantics></math>
give ‚Äúthe same‚Äù (more in a second) output for
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>t</mi><mrow><mi>j</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>Y</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>t</mi><mi>j</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><msubsup><mo>‚à´</mo><msub><mi>t</mi><mi>j</mi></msub><msub><mi>t</mi><mrow><mi>j</mi><mo>+</mo><mn>1</mn></mrow></msub></msubsup><mi>f</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>Y</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo><mi>ùõâ</mi><mo stretchy="true" form="postfix">)</mo></mrow><mspace width="0.167em"></mspace><mi>d</mi><mi>t</mi><mspace width="2.0em"></mspace><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">Y(t_{j+1}) = Y(t_j) + \int_{t_j}^{t_{j+1}} f(Y(t), \boldsymbol{\theta})\,dt\qquad (1)</annotation></semantics></math>
the MCMC sampler will be unable to meaningfully distinguish the
parameter combinations. What you see in practice is chains converging to
extremely different parameter combinations, one of which is the `true‚Äô
combination, the other of which is wrong but produces the same
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mi>Y</mi><mo accent="true">ÃÇ</mo></mover><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>t</mi><mi>j</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\hat{Y}(t_j)</annotation></semantics></math>
values due to the numerical error. Thus, there is a form of
non-identifiability that arises from numerical errors in a longitudinal
model based on Equation (1) that are separate to other issues of
non-identifiability, and currently under-explored in the literature. In
this demonstration we use a Runge-Kutta 4th order numerical method ()
with different step sizes to show that even ‚Äòsmall‚Äô step sizes can give
problems.</p>
<p>It is important to state that ‚Äúthe same‚Äù
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">Y(t)</annotation></semantics></math>
values in this context means within statistical error of each other. We
assume that our data consists of observations of the form
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>y</mi><mi>j</mi></msub><annotation encoding="application/x-tex">y_{j}</annotation></semantics></math>
at time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>t</mi><mi>j</mi></msub><annotation encoding="application/x-tex">t_j</annotation></semantics></math>
that look like
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>j</mi></msub><mo>=</mo><mi>Y</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>t</mi><mi>j</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mtext mathvariant="normal">error</mtext><mo>,</mo></mrow><annotation encoding="application/x-tex">y_j = Y(t_j) + \text{error},</annotation></semantics></math>
and have some finite level of precision. The numerical method may
produce estimated values
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mi>Y</mi><mo accent="true">ÃÇ</mo></mover><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>t</mi><mi>j</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\hat{Y}(t_j)</annotation></semantics></math>
that differ by some amount that is much smaller than the level of
precision or observation error for the different parameter combinations,
but due to the imprecision of the measurement process the MCMC sampler
cannot meaningfully distinguish the estimates.</p>
<p>For this demonstration we will simulate data as though it is measured
in centimetres. We use rounding to produce simulated data with
measurement precision of 0.1cm, and error of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ùí©</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><mn>0.1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mathcal{N}(0, 0.1)</annotation></semantics></math>,
analogous to the 1mm measurement precision and approximate standard
deviation of the real-world source data used in <span class="citation">O‚ÄôBrien, Warton, and Falster (2024)</span>.</p>
</div>
<div class="section level3">
<h3 id="the-model">The model<a class="anchor" aria-label="anchor" href="#the-model"></a>
</h3>
<p>We are implementing a longitudinal model of the form in Equation (1)
within a hierarchical Bayesian longitudinal model where
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>Y</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo><msub><mi>Œ≤</mi><mn>0</mn></msub><mo>,</mo><msub><mi>Œ≤</mi><mn>1</mn></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>Œ≤</mi><mn>0</mn></msub><mo>‚àí</mo><msub><mi>Œ≤</mi><mn>1</mn></msub><mi>Y</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mspace width="2.0em"></mspace><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">f(Y(t), \beta_0, \beta_1) = \beta_0 - \beta_1 Y(t)\qquad (2)</annotation></semantics></math>
Equation (2) is known to produce pathological behaviour from numerical
methods <span class="citation">(Butcher 2016)</span>, so serves as an
ideal simple example of the interaction between those pathologies and
the MCMC sampling process. For the purpose of estimation we shift
Equation (2) by the mean observed size which gives
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mrow><mi>f</mi><mi>i</mi><mi>t</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>Y</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo><msub><mi>Œ≤</mi><mi>c</mi></msub><mo>,</mo><msub><mi>Œ≤</mi><mn>1</mn></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>Œ≤</mi><mi>c</mi></msub><mo>‚àí</mo><msub><mi>Œ≤</mi><mn>1</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>Y</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>‚àí</mo><mover><mi>y</mi><mo accent="true">‚Äæ</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo></mrow><annotation encoding="application/x-tex">f_{fit}(Y(t), \beta_c, \beta_1) = \beta_c - \beta_1(Y(t) - \bar{y}),</annotation></semantics></math>
then the back-transformation
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Œ≤</mi><mn>0</mn></msub><mo>=</mo><msub><mi>Œ≤</mi><mi>c</mi></msub><mo>+</mo><msub><mi>Œ≤</mi><mn>1</mn></msub><mover><mi>y</mi><mo accent="true">‚Äæ</mo></mover><mi>.</mi></mrow><annotation encoding="application/x-tex">\beta_0 = \beta_c + \beta_1 \bar{y}.</annotation></semantics></math></p>
<p>We are attempting to estimate the parameters
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Œ≤</mi><mn>0</mn></msub><annotation encoding="application/x-tex">\beta_0</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Œ≤</mi><mn>1</mn></msub><annotation encoding="application/x-tex">\beta_1</annotation></semantics></math>
from observations
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>y</mi><mi>j</mi></msub><annotation encoding="application/x-tex">y_j</annotation></semantics></math>,
which is based on estimating
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mover><mi>Y</mi><mo accent="true">ÃÇ</mo></mover><mi>j</mi></msub><annotation encoding="application/x-tex">\hat{Y}_j</annotation></semantics></math>
given the prior distribution
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>j</mi></msub><mo>‚àº</mo><mi>ùí©</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mover><mi>Y</mi><mo accent="true">ÃÇ</mo></mover><mi>j</mi></msub><mo>,</mo><mn>0.1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mi>.</mi></mrow><annotation encoding="application/x-tex">y_j \sim \mathcal{N}(\hat{Y}_j, 0.1).</annotation></semantics></math></p>
<p>As we are looking at a single individual, we have prior distributions
for the default parameters which are
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Œ≤</mi><mn>1</mn></msub><mo>,</mo><msub><mi>Œ≤</mi><mi>c</mi></msub><mo>‚àº</mo><mo>log</mo><mi>ùí©</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><mn>2</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo></mrow><annotation encoding="application/x-tex">\beta_1, \beta_c \sim \log\mathcal{N}(0,2),</annotation></semantics></math>
and enforce
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Œ≤</mi><mi>k</mi></msub><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\beta_k &gt; 0</annotation></semantics></math>.</p>
</div>
<div class="section level3">
<h3 id="simulating-data">Simulating data<a class="anchor" aria-label="anchor" href="#simulating-data"></a>
</h3>
<p>For this demo code we use
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Œ≤</mi><mn>0</mn></msub><mo>=</mo><mn>10</mn></mrow><annotation encoding="application/x-tex">\beta_0 = 10</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Œ≤</mi><mn>1</mn></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\beta_1 = 1</annotation></semantics></math>,
which gives an asymptotic size of 10. If you wish to experiment with
other values, input them in the next block and the rest will run based
on that. We use the analytic solution to simulate true sizes over time,
then add measurement error and round to the chosen measurement precision
of 0.1cm to give a sequence of observations over time that become the
<code>y_obs</code> data for the model fit. Notice that
<code>y_obs</code> can produces values that are bigger than the
theoretical asymptotic size
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Œ≤</mi><mn>0</mn></msub><mi>/</mi><msub><mi>Œ≤</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">\beta_0/\beta_1</annotation></semantics></math>
due to error.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Change these values to change the model parameters. Must be positive values.</span></span>
<span><span class="va">beta_0</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">beta_1</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="co">#True initial condition</span></span>
<span><span class="va">true_y_0</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">max_time</span> <span class="op">&lt;-</span> <span class="fl">9</span></span>
<span><span class="va">time</span> <span class="op">&lt;-</span> <span class="fl">0</span><span class="op">:</span><span class="va">max_time</span></span>
<span></span>
<span><span class="co">#Analytic solution</span></span>
<span><span class="va">analytic_solution</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">pars</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span><span class="op">{</span> <span class="co">#Pars is list of beta_0, beta_1, y_0</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span></span>
<span>    <span class="op">(</span><span class="va">pars</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">/</span><span class="va">pars</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">pars</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span> <span class="op">-</span> <span class="op">(</span><span class="va">pars</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">/</span><span class="va">pars</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">pars</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">*</span> <span class="va">x</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">true_pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  beta_0 <span class="op">=</span> <span class="va">beta_0</span>,</span>
<span>  beta_1 <span class="op">=</span> <span class="va">beta_1</span>,</span>
<span>  true_y_0 <span class="op">=</span> <span class="va">true_y_0</span></span>
<span><span class="op">)</span></span>
<span><span class="va">true_args_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">beta_0</span>,</span>
<span>                             <span class="va">beta_1</span>,</span>
<span>                             <span class="va">true_y_0</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">y_true</span> <span class="op">&lt;-</span> <span class="fu">analytic_solution</span><span class="op">(</span><span class="va">time</span>, <span class="va">true_pars</span><span class="op">)</span></span></code></pre></div>
<p>From the analytic solution we produce observations by adding
measurement error and rounding to a precision of 0.1.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Produce observations with error and limited precision</span></span>
<span><span class="va">y_obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">y_true</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">y_true</span><span class="op">)</span>, <span class="fl">0</span>, <span class="fl">0.1</span><span class="op">)</span>, digits <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Unrounded data if needed</span></span>
<span><span class="co">#y_obs &lt;- y_true + rnorm(length(y_true), 0, 0.1)</span></span>
<span></span>
<span><span class="co">#Observed data frame</span></span>
<span><span class="va">obs_data_frame</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  time <span class="op">=</span> <span class="va">time</span>,</span>
<span>  y_obs <span class="op">=</span> <span class="va">y_obs</span>,</span>
<span>  obs_index <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">y_obs</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Have a look at the true and 'observed' data</span></span>
<span><span class="va">plot_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">time</span><span class="op">)</span>,</span>
<span>  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">y_true</span>,<span class="va">y_obs</span><span class="op">)</span>,</span>
<span>  Data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"True sizes"</span>, times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">y_true</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"Obs. sizes"</span>, times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">y_obs</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">sizes_over_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">plot_data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, group <span class="op">=</span> <span class="va">Data</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="va">Data</span>, shape <span class="op">=</span> <span class="va">Data</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="va">Data</span>, linetype <span class="op">=</span> <span class="va">Data</span><span class="op">)</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_linetype_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"dashed"</span>, <span class="st">"dotted"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Time"</span>, y <span class="op">=</span> <span class="st">"Y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"inside"</span>,</span>
<span>        legend.position.inside <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.7</span>, <span class="fl">0.3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sizes_over_time</span></span></code></pre></div>
<p><img src="here_be_dragons_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#Have a look at the observations against the analytic solution</span></span>
<span><span class="va">analytic_observed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">obs_data_frame</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">y_obs</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_function.html" class="external-link">geom_function</a></span><span class="op">(</span>fun<span class="op">=</span><span class="va">analytic_solution</span>, args <span class="op">=</span> <span class="va">true_args_list</span>,</span>
<span>                linewidth <span class="op">=</span> <span class="fl">1</span>, colour <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"darkorchid"</span>, size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"darkorchid"</span>, linewidth <span class="op">=</span> <span class="fl">1</span>,</span>
<span>            linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Time"</span>, y <span class="op">=</span> <span class="st">"Y"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"Data simulation"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">analytic_observed</span></span></code></pre></div>
<p><img src="here_be_dragons_files/figure-html/unnamed-chunk-4-2.png" width="700"></p>
<p>A note on error and precision: the same bad behaviour occurs even if
you use unrounded data with all the precision R offers and much smaller
error. You can test this by uncommenting the line that rounds the data
and/or changing the measurement error standard deviation. The chosen
values, and rounding, are intended to demonstrate that this is a problem
that may occur with realistic precision and error.</p>
</div>
<div class="section level3">
<h3 id="implementing-models-and-collecting-posterior-estimates">Implementing models and collecting posterior estimates<a class="anchor" aria-label="anchor" href="#implementing-models-and-collecting-posterior-estimates"></a>
</h3>
<p>In this section we are going to run a sequence of sets of models. The
first batch is about checking for the existence of bimodal posterior
distributions across different step sizes for the same numerical method.
We then use a different numerical method to see if the problem persists.
Lastly, we use different means in the parameter priors to see if the
posterior can be constrained by such methods.</p>
<div class="section level4">
<h4 id="step-size-data">Step size data<a class="anchor" aria-label="anchor" href="#step-size-data"></a>
</h4>
<p>We‚Äôre going to run 100 fits with a step size of 1 using the custom
RK4 solver and a single chain each. Each chain is expected to converge
to a parameter combination that gives estimated
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mi>Y</mi><mo accent="true">ÃÇ</mo></mover><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>t</mi><mi>j</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\hat{Y}(t_j)</annotation></semantics></math>
close to the analytic solution, but which combination is converged to is
random. We do single chains because each can fall into the numerical
error trap, and the easiest way to identify that trap is to extract the
estimates afterwards.</p>
<p>Each fit takes a few seconds to run, so allow several minutes for the
following block. There are likely to be diagnostic problems but that is
part of what we are here to explore so we will be ignoring them.
Divergent transitions in particular are to be expected when we have the
very different parameter estimates we see. Results are hidden for this
block.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">runs</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">step_size</span> <span class="op">=</span> <span class="fl">0.5</span></span>
<span><span class="va">par_est_tibble</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>run <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                         step_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                         beta_0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                         beta_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">runs</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co">#Run the model</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span></span>
<span>    <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hmde_model.html">hmde_model</a></span><span class="op">(</span><span class="st">"affine_single_ind"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/hmde_assign_data.html">hmde_assign_data</a></span><span class="op">(</span>n_obs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">obs_data_frame</span><span class="op">)</span>,</span>
<span>                     y_obs <span class="op">=</span> <span class="va">obs_data_frame</span><span class="op">$</span><span class="va">y_obs</span>,</span>
<span>                     obs_index <span class="op">=</span> <span class="va">obs_data_frame</span><span class="op">$</span><span class="va">obs_index</span>,</span>
<span>                     time <span class="op">=</span> <span class="va">obs_data_frame</span><span class="op">$</span><span class="va">time</span>,</span>
<span>                     y_bar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">obs_data_frame</span><span class="op">$</span><span class="va">y_obs</span><span class="op">)</span>,</span>
<span>                     step_size <span class="op">=</span> <span class="va">step_size</span>,</span>
<span>                     int_method <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>  <span class="op">|&gt;</span>  <span class="co">#RK4</span></span>
<span>    <span class="fu"><a href="../reference/hmde_run.html">hmde_run</a></span><span class="op">(</span>chains <span class="op">=</span> <span class="fl">1</span>, cores <span class="op">=</span> <span class="fl">1</span>, iter <span class="op">=</span> <span class="fl">2000</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#Extract parameter estimates</span></span>
<span>  <span class="va">ests</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hmde_extract_estimates.html">hmde_extract_estimates</a></span><span class="op">(</span>fit <span class="op">=</span> <span class="va">fit</span>,</span>
<span>                                 input_measurement_data <span class="op">=</span> <span class="va">obs_data_frame</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>    run <span class="op">=</span> <span class="va">i</span>,</span>
<span>    step_size <span class="op">=</span> <span class="va">step_size</span>,</span>
<span>    beta_0 <span class="op">=</span> <span class="va">ests</span><span class="op">$</span><span class="va">individual_data</span><span class="op">$</span><span class="va">ind_beta_0_mean</span>,</span>
<span>    beta_1 <span class="op">=</span> <span class="va">ests</span><span class="op">$</span><span class="va">individual_data</span><span class="op">$</span><span class="va">ind_beta_1_mean</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">par_est_tibble</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">par_est_tibble</span>, <span class="va">temp</span><span class="op">)</span></span>
<span><span class="op">}</span> </span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="analysis">Analysis<a class="anchor" aria-label="anchor" href="#analysis"></a>
</h3>
<p>We are going to fit a finite mixture model to tell us about the
clustering in the posterior distributions. We assume that there are two
clusters (you can check with scatter plots), that one is close to the
true values and the other some distance away with much larger estimates
for both, and use the mean for rows where <span class="math inline">$\hat{\beta_}_0 &gt; mean(\hat{\beta_}_0)$</span> as
our starting value for the iterative process to avoid singularities. The
overall mean of the estimates works as a threshold for extreme values
because of the bimodality and distance between clusters.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">step_size_mix_models</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">step_size_mix_model_plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">step_size_mix_models_par_ests</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  good_beta_0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  good_beta_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  error_beta_0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  error_beta_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  step_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  error_fraction <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  dist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">par_est_tibble</span><span class="op">$</span><span class="va">step_size</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co">#Get data for single step size</span></span>
<span>  <span class="va">step_size_selected</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">par_est_tibble</span><span class="op">$</span><span class="va">step_size</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">analysis_data</span> <span class="op">&lt;-</span> <span class="va">par_est_tibble</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">step_size</span> <span class="op">==</span> <span class="va">step_size_selected</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#Get some extreme estimates</span></span>
<span>  <span class="va">possible_error</span> <span class="op">&lt;-</span> <span class="va">analysis_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">beta_0</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">analysis_data</span><span class="op">$</span><span class="va">beta_0</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#To speed up the iterative algorithm we provide some initial conditions</span></span>
<span>  <span class="va">mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span> <span class="co">#Means from true parameters and extreme estimates</span></span>
<span>    true <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">beta_0</span>, <span class="va">beta_1</span><span class="op">)</span>,</span>
<span>    error <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">possible_error</span><span class="op">$</span><span class="va">beta_0</span><span class="op">)</span>, </span>
<span>              <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">possible_error</span><span class="op">$</span><span class="va">beta_1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#Fit multivariate normal finite mixture model to the estimates</span></span>
<span>  <span class="va">step_size_mix_models</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixtools/man/mvnormalmixEM.html" class="external-link">mvnormalmixEM</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">analysis_data</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">4</span><span class="op">)</span><span class="op">]</span>, mu <span class="op">=</span> <span class="va">mu</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Summary of mixture model for step size "</span>, <span class="va">step_size_selected</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">step_size_mix_models</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">step_size_mix_model_plots</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">step_size_mix_models</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, </span>
<span>                               whichplots <span class="op">=</span> <span class="fl">2</span>, </span>
<span>                               xlab2 <span class="op">=</span> <span class="st">"Beta 0"</span>, </span>
<span>                               ylab2 <span class="op">=</span> <span class="st">"Beta 1"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">dist_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span> <span class="co">#Data to calculate distance</span></span>
<span>    b_0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">step_size_mix_models</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">mu</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, </span>
<span>            <span class="va">step_size_mix_models</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">mu</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    b_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">step_size_mix_models</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">mu</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, </span>
<span>            <span class="va">step_size_mix_models</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">mu</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#Extract values</span></span>
<span>  <span class="va">step_size_mix_models_par_ests_temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>    good_beta_0 <span class="op">=</span> <span class="va">step_size_mix_models</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">mu</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>    good_beta_1 <span class="op">=</span> <span class="va">step_size_mix_models</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">mu</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,</span>
<span>    error_beta_0 <span class="op">=</span> <span class="va">step_size_mix_models</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">mu</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>    error_beta_1 <span class="op">=</span> <span class="va">step_size_mix_models</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">mu</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,</span>
<span>    step_size <span class="op">=</span> <span class="va">step_size_selected</span>,</span>
<span>    error_prob <span class="op">=</span> <span class="va">step_size_mix_models</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">lambda</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,</span>
<span>    dist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/dist.html" class="external-link">dist</a></span><span class="op">(</span><span class="va">dist_table</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">step_size_mix_models_par_ests</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">step_size_mix_models_par_ests</span>, </span>
<span>                                         <span class="va">step_size_mix_models_par_ests_temp</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; number of iterations= 3 </span></span>
<span><span class="co">#&gt; [1] "Summary of mixture model for step size 0.5"</span></span>
<span><span class="co">#&gt; summary of mvnormalmixEM object:</span></span>
<span><span class="co">#&gt;          comp 1   comp 2</span></span>
<span><span class="co">#&gt; lambda 0.670000  0.33000</span></span>
<span><span class="co">#&gt; mu1    9.810421 49.16390</span></span>
<span><span class="co">#&gt; mu2    0.980554  4.92054</span></span>
<span><span class="co">#&gt; loglik at estimate:  992.063 </span></span>
<span><span class="co">#&gt; NULL</span></span></code></pre></div>
<p><img src="here_be_dragons_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#Have a look at the estimates</span></span>
<span><span class="va">step_size_mix_models_par_ests</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 √ó 7</span></span></span>
<span><span class="co">#&gt;   good_beta_0 good_beta_1 error_beta_0 error_beta_1 step_size error_prob dist   </span></span>
<span><span class="co">#&gt;         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dist&gt;</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>        9.81       0.981         49.2         4.92       0.5       0.33 39.550‚Ä¶</span></span></code></pre></div>
<p>We get bimodality in the posterior distributions. If you look at
multiple step sizes you will see that smaller step sizes push the second
cluster further away. Bias in the estimates closest to the true values
is due to the same measurement error in the ‚Äòobserved‚Äô data for all the
fits. The second mode in the estimates arises from the numerical
integration error as we will verify shortly. The extreme bimodality of
the posterior is consistent behaviour, even though the point of the
second mode shifts based on the step size.</p>
<p>Some aesthetics before plots.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">legend_spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  step_size_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"0.5"</span>, <span class="st">"0.25"</span>, <span class="st">"0.125"</span><span class="op">)</span>,</span>
<span>  step_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.25</span>, <span class="fl">0.125</span><span class="op">)</span>,</span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">10</span>, <span class="op">-</span><span class="fl">10</span>, <span class="op">-</span><span class="fl">10</span><span class="op">)</span>,</span>
<span>  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">10</span>, <span class="op">-</span><span class="fl">10</span>, <span class="op">-</span><span class="fl">10</span><span class="op">)</span>,</span>
<span>  colours <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#f8766d"</span>, <span class="st">"#00ba38"</span>, <span class="st">"#609cff"</span><span class="op">)</span>,</span>
<span>  linetypes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"longdash"</span>, <span class="st">"dashed"</span>, <span class="st">"dotted"</span><span class="op">)</span>,</span>
<span>  shapes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">19</span>, <span class="fl">17</span>, <span class="fl">15</span><span class="op">)</span></span>
<span><span class="op">)</span> </span>
<span></span>
<span><span class="va">legend_spec_with_true</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  step_size_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"0.5"</span>, <span class="st">"0.25"</span>, <span class="st">"0.125"</span>, <span class="st">"True pars"</span><span class="op">)</span>,</span>
<span>  step_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.25</span>, <span class="fl">0.125</span>, <span class="cn">NA</span><span class="op">)</span>,</span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">10</span>, <span class="op">-</span><span class="fl">10</span>, <span class="op">-</span><span class="fl">10</span>, <span class="op">-</span><span class="fl">10</span><span class="op">)</span>,</span>
<span>  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">10</span>, <span class="op">-</span><span class="fl">10</span>, <span class="op">-</span><span class="fl">10</span>, <span class="op">-</span><span class="fl">10</span><span class="op">)</span>,</span>
<span>  colours <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#f8766d"</span>, <span class="st">"#00ba38"</span>, <span class="st">"#609cff"</span>, <span class="st">"black"</span><span class="op">)</span>,</span>
<span>  linetypes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"longdash"</span>, <span class="st">"dashed"</span>, <span class="st">"dotted"</span>, <span class="st">"solid"</span><span class="op">)</span>,</span>
<span>  shapes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">19</span>, <span class="fl">17</span>, <span class="fl">15</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">legend_spec</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">fancy_name_no_step_size</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Beta_0 = "</span>,</span>
<span>         <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">signif</a></span><span class="op">(</span><span class="va">step_size_mix_models_par_ests</span><span class="op">$</span><span class="va">error_beta_0</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>                digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>         <span class="st">",\n Beta_1 = "</span>,</span>
<span>         <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">signif</a></span><span class="op">(</span><span class="va">step_size_mix_models_par_ests</span><span class="op">$</span><span class="va">error_beta_1</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>                             digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">legend_spec</span><span class="op">$</span><span class="va">fancy_name_no_step_size</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">fancy_name_no_step_size</span></span>
<span>  <span class="va">legend_spec_with_true</span><span class="op">$</span><span class="va">fancy_name_no_step_size</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">fancy_name_no_step_size</span></span>
<span>  </span>
<span>  <span class="va">fancy_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Step size "</span>, <span class="va">step_size_mix_models_par_ests</span><span class="op">$</span><span class="va">step_size</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>                       <span class="st">"\n"</span>, <span class="va">fancy_name_no_step_size</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">legend_spec</span><span class="op">$</span><span class="va">fancy_name</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">fancy_name</span></span>
<span>  <span class="va">legend_spec_with_true</span><span class="op">$</span><span class="va">fancy_name</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">fancy_name</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Warning: Unknown or uninitialised column: `fancy_name_no_step_size`.</span></span>
<span><span class="co">#&gt; Unknown or uninitialised column: `fancy_name_no_step_size`.</span></span>
<span><span class="co">#&gt; Warning: Unknown or uninitialised column: `fancy_name`.</span></span>
<span><span class="co">#&gt; Unknown or uninitialised column: `fancy_name`.</span></span>
<span></span>
<span><span class="va">legend_spec_with_true</span><span class="op">$</span><span class="va">fancy_name_no_step_size</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Beta_0 = "</span>,</span>
<span>         <span class="va">beta_0</span>,</span>
<span>         <span class="st">",\n Beta_1 = "</span>,</span>
<span>         <span class="va">beta_1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">legend_spec_with_true</span><span class="op">$</span><span class="va">fancy_name</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"True values\n Beta_0 = "</span>,</span>
<span>         <span class="va">beta_0</span>,</span>
<span>         <span class="st">",\n Beta_1 = "</span>,</span>
<span>         <span class="va">beta_1</span><span class="op">)</span></span></code></pre></div>
<p>We use scatter plots of the clusters for qualitative analysis. As the
clusters are so distant from each other, and so tight around their
means, we separate them out for plots. The mixture models gives a
classification of each point in the data that we use to filter
observations. As the clusters are so distant we can use other heuristics
such as <span class="math inline">$\hat{\beta_}_0 &gt; 2\beta_0$</span>
which agree perfectly with the cluster analysis.</p>
<p>The contours over the scatter plot come from data simulated from the
cluster‚Äôs multivariate normal distribution identified by the finite
mixture model.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scatterplot_errors_only</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">scatterplot_good_only</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">par_est_tibble</span><span class="op">$</span><span class="va">step_size</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">step_size_select</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">par_est_tibble</span><span class="op">$</span><span class="va">step_size</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">plot_data</span> <span class="op">&lt;-</span> <span class="va">par_est_tibble</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">step_size</span> <span class="op">==</span> <span class="va">step_size_select</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#Get classification from mixture model</span></span>
<span>  <span class="va">plot_data</span><span class="op">$</span><span class="va">good_est</span> <span class="op">&lt;-</span> <span class="va">step_size_mix_models</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"posterior"</span><span class="op">]</span><span class="op">]</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">error_ests_scatter</span> <span class="op">&lt;-</span> <span class="va">plot_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">as.logical</a></span><span class="op">(</span><span class="va">good_est</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">good_ests_scatter</span> <span class="op">&lt;-</span> <span class="va">plot_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">as.logical</a></span><span class="op">(</span><span class="va">good_est</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#Scatter plot of erroneous parameters</span></span>
<span>  <span class="va">xpos</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">error_ests_scatter</span><span class="op">$</span><span class="va">beta_0</span><span class="op">)</span> <span class="op">+</span> </span>
<span>             <span class="fl">0.2</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">error_ests_scatter</span><span class="op">$</span><span class="va">beta_0</span><span class="op">)</span> <span class="op">-</span> </span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">error_ests_scatter</span><span class="op">$</span><span class="va">beta_0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">ypos</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">error_ests_scatter</span><span class="op">$</span><span class="va">beta_1</span><span class="op">)</span> <span class="op">-</span> </span>
<span>             <span class="fl">0.1</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">error_ests_scatter</span><span class="op">$</span><span class="va">beta_1</span><span class="op">)</span> <span class="op">-</span> </span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">error_ests_scatter</span><span class="op">$</span><span class="va">beta_1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">norm_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html" class="external-link">mvrnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">10000</span>,</span>
<span>                       mu <span class="op">=</span> <span class="va">step_size_mix_models</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"mu"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>,</span>
<span>                       Sigma <span class="op">=</span> <span class="va">step_size_mix_models</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"sigma"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">norm_data</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"beta_0"</span>, <span class="st">"beta_1"</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="va">scatterplot_errors_only</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">error_ests_scatter</span>, </span>
<span>                                         <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">beta_0</span>, y <span class="op">=</span> <span class="va">beta_1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="va">legend_spec</span><span class="op">$</span><span class="va">colours</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>               shape <span class="op">=</span> <span class="va">legend_spec</span><span class="op">$</span><span class="va">shapes</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>               alpha <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>               size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density_2d.html" class="external-link">geom_density_2d</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">norm_data</span>, colour <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"beta_0 est."</span>,</span>
<span>           y <span class="op">=</span> <span class="st">"beta_1 est."</span>,</span>
<span>           title <span class="op">=</span> <span class="st">"Second cluster"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span><span class="st">"text"</span>, x <span class="op">=</span> <span class="va">xpos</span>, y <span class="op">=</span> <span class="va">ypos</span>, </span>
<span>             label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Probability: \n"</span>,</span>
<span>                            <span class="va">step_size_mix_models_par_ests</span><span class="op">$</span><span class="va">error_prob</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#Scatter plot of good parameter estimates</span></span>
<span>  <span class="va">xpos</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">good_ests_scatter</span><span class="op">$</span><span class="va">beta_0</span><span class="op">)</span> <span class="op">+</span> </span>
<span>             <span class="fl">0.2</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">good_ests_scatter</span><span class="op">$</span><span class="va">beta_0</span><span class="op">)</span> <span class="op">-</span> </span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">good_ests_scatter</span><span class="op">$</span><span class="va">beta_0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">ypos</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">good_ests_scatter</span><span class="op">$</span><span class="va">beta_1</span><span class="op">)</span> <span class="op">-</span> </span>
<span>             <span class="fl">0.1</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">good_ests_scatter</span><span class="op">$</span><span class="va">beta_1</span><span class="op">)</span> <span class="op">-</span> </span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">good_ests_scatter</span><span class="op">$</span><span class="va">beta_1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">norm_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html" class="external-link">mvrnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">10000</span>,</span>
<span>                       mu <span class="op">=</span> <span class="va">step_size_mix_models</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"mu"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,</span>
<span>                       Sigma <span class="op">=</span> <span class="va">step_size_mix_models</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"sigma"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">norm_data</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"beta_0"</span>, <span class="st">"beta_1"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">scatterplot_good_only</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">good_ests_scatter</span>, </span>
<span>                                         <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">beta_0</span>, y <span class="op">=</span> <span class="va">beta_1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="va">legend_spec</span><span class="op">$</span><span class="va">colours</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>               shape <span class="op">=</span> <span class="va">legend_spec</span><span class="op">$</span><span class="va">shapes</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>               alpha <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>               size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density_2d.html" class="external-link">geom_density_2d</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">norm_data</span>, colour <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"beta_0 est."</span>,</span>
<span>           y <span class="op">=</span> <span class="st">"beta_1 est."</span>,</span>
<span>           title <span class="op">=</span> <span class="st">"First cluster"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span><span class="st">"text"</span>, x <span class="op">=</span> <span class="va">xpos</span>, y <span class="op">=</span> <span class="va">ypos</span>, </span>
<span>             label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Probability: \n"</span>,</span>
<span>                            <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">step_size_mix_models_par_ests</span><span class="op">$</span><span class="va">error_prob</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We can double-check the numerical error by using an independent
solver with the same step size. We use the <code>deSolve</code> package
which has an implementation of RK4 and allows us to choose the step
sizes using the time parameter.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#install.packages("deSolve")</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://desolve.r-forge.r-project.org/" class="external-link">deSolve</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Create DE function</span></span>
<span><span class="va">DE</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">Time</span>, <span class="va">State</span>, <span class="va">Pars</span><span class="op">)</span> <span class="op">{</span> <span class="co">#Implementation of DE</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">State</span>, <span class="va">Pars</span><span class="op">)</span><span class="op">)</span>, <span class="op">{</span></span>
<span>    <span class="va">dY</span> <span class="op">&lt;-</span> <span class="va">beta_0</span> <span class="op">-</span> <span class="va">beta_1</span> <span class="op">*</span> <span class="va">Y</span></span>
<span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">dY</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="section level4">
<h4 id="second-cluster-analysis">Second cluster analysis<a class="anchor" aria-label="anchor" href="#second-cluster-analysis"></a>
</h4>
<p>We want to look at the behaviour of the numerical method for the bad
estimate clusters. To do so we project forward from the initial
condition using the chosen step size, bad parameter combination, and see
what happens. We can compare the numerical solution to both the true
sizes over time, and to the analytic solution with those same bad
parameter estimates.</p>
<p>First we generate the numerical and analytic solution data.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">yini</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>Y <span class="op">=</span> <span class="va">true_y_0</span><span class="op">)</span> <span class="co">#Initial condition</span></span>
<span><span class="va">y_over_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>model<span class="op">=</span><span class="st">"True Sizes"</span>,</span>
<span>                      y_analytic <span class="op">=</span> <span class="va">y_true</span>,</span>
<span>                      y_numeric <span class="op">=</span> <span class="va">y_true</span>,</span>
<span>                      time <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="va">max_time</span>,</span>
<span>                      beta_0_par <span class="op">=</span> <span class="va">beta_0</span>,</span>
<span>                      beta_1_par <span class="op">=</span> <span class="va">beta_1</span></span>
<span>                      <span class="op">)</span></span>
<span></span>
<span><span class="co">#Generate Y(t) with RK4</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">step_size_mix_models_par_ests</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">pars_combo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>beta_0 <span class="op">=</span> <span class="va">step_size_mix_models_par_ests</span><span class="op">$</span><span class="va">error_beta_0</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>                    beta_1 <span class="op">=</span> <span class="va">step_size_mix_models_par_ests</span><span class="op">$</span><span class="va">error_beta_1</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">max_time</span>, by <span class="op">=</span> <span class="va">step_size_mix_models_par_ests</span><span class="op">$</span><span class="va">step_size</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">solution_pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">pars_combo</span>, <span class="va">true_y_0</span><span class="op">)</span></span>
<span>  <span class="va">y_true_temp</span> <span class="op">&lt;-</span> <span class="fu">analytic_solution</span><span class="op">(</span><span class="va">times</span>, <span class="va">solution_pars</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="va">numerical_output</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/deSolve/man/ode.html" class="external-link">ode</a></span><span class="op">(</span><span class="va">yini</span>, <span class="va">times</span>, <span class="va">DE</span>, <span class="va">pars_combo</span>, method <span class="op">=</span> <span class="st">"rk4"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">y_over_time_temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>    model <span class="op">=</span> <span class="va">step_size_mix_models_par_ests</span><span class="op">$</span><span class="va">step_size</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>    y_analytic <span class="op">=</span> <span class="va">y_true_temp</span>,</span>
<span>    y_numeric <span class="op">=</span> <span class="va">numerical_output</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>,</span>
<span>    time <span class="op">=</span> <span class="va">times</span>,</span>
<span>    beta_0_par <span class="op">=</span> <span class="va">step_size_mix_models_par_ests</span><span class="op">$</span><span class="va">error_beta_0</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>    beta_1_par <span class="op">=</span> <span class="va">step_size_mix_models_par_ests</span><span class="op">$</span><span class="va">error_beta_1</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">y_over_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">y_over_time</span>, <span class="va">y_over_time_temp</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Here is a figure that shows all of the estimated sizes over time for
the bad parameter combinations across different step sizes, compared to
the true values.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_over_time_filtered</span> <span class="op">&lt;-</span> <span class="va">y_over_time</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">time</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fl">0</span><span class="op">:</span><span class="va">max_time</span><span class="op">)</span></span>
<span>  </span>
<span><span class="co">#Plot sizes over time for all models</span></span>
<span><span class="va">compare_sizes_over_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">y_over_time_filtered</span>, </span>
<span>                                  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">time</span>, y<span class="op">=</span><span class="va">y_numeric</span>, group_by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span>,</span>
<span>             shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             alpha<span class="op">=</span><span class="fl">0.5</span>, size <span class="op">=</span> <span class="fl">2</span>, stroke <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span><span class="op">)</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_colour_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">legend_spec_with_true</span><span class="op">$</span><span class="va">colours</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_shape_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">legend_spec_with_true</span><span class="op">$</span><span class="va">shapes</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Time"</span>, y <span class="op">=</span> <span class="st">"Y(t)"</span>, title <span class="op">=</span> <span class="st">"Estimated Y(t) with bad parameters"</span>,</span>
<span>       colour <span class="op">=</span> <span class="st">"Step size"</span>, shape <span class="op">=</span> <span class="st">"Step size"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"inside"</span>,</span>
<span>        legend.position.inside <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.7</span>, <span class="fl">0.3</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">compare_sizes_over_time</span></span></code></pre></div>
<p><img src="here_be_dragons_files/figure-html/unnamed-chunk-11-1.png" width="700">
These are indistinguishable values. If you look extremely closely you
get some deviation due to parameter bias, but that is not statistically
relevant to the process.</p>
<p>To demonstrate that a smaller step size to test the method is enough
to identify bad estimates, we show that RK4 with step size 0.001
diverges from the true sizes over time. The lines in this plot are based
on the small step size numerical estimates, while the points come from
the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>t</mi><mi>j</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">Y(t_j)</annotation></semantics></math>
values for the discrete observation times.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Generate y(t) with RK4 given the parameter estimates</span></span>
<span><span class="va">y_over_time_smallstep</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>model<span class="op">=</span><span class="va">legend_spec_with_true</span><span class="op">$</span><span class="va">fancy_name</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>,</span>
<span>                      y_hat <span class="op">=</span> <span class="va">y_true</span>,</span>
<span>                      time <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="va">max_time</span></span>
<span>                      <span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">step_size_mix_models_par_ests</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">pars_combo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>beta_0 <span class="op">=</span> <span class="va">step_size_mix_models_par_ests</span><span class="op">$</span><span class="va">error_beta_0</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>                    beta_1 <span class="op">=</span> <span class="va">step_size_mix_models_par_ests</span><span class="op">$</span><span class="va">error_beta_1</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">max_time</span>, by <span class="op">=</span> <span class="fl">0.001</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">numerical_output</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/deSolve/man/ode.html" class="external-link">ode</a></span><span class="op">(</span><span class="va">yini</span>, <span class="va">times</span>, <span class="va">DE</span>, <span class="va">pars_combo</span>, method <span class="op">=</span> <span class="st">"rk4"</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">y_over_time_temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>      model <span class="op">=</span> <span class="va">legend_spec_with_true</span><span class="op">$</span><span class="va">fancy_name_no_step_size</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>      y_hat <span class="op">=</span> <span class="va">numerical_output</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>,</span>
<span>      time <span class="op">=</span> <span class="va">times</span></span>
<span>    <span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">y_over_time_smallstep</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">y_over_time_smallstep</span>, <span class="va">y_over_time_temp</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">point_data</span> <span class="op">&lt;-</span> <span class="va">y_over_time_smallstep</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">time</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fl">0</span><span class="op">:</span><span class="va">max_time</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Plot sizes over time</span></span>
<span><span class="va">compare_sizes_over_time_smallstep</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">y_over_time_smallstep</span>, </span>
<span>                                  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">time</span>, y<span class="op">=</span><span class="va">y_hat</span>, grouping <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span>,</span>
<span>                linetype <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span><span class="op">)</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">point_data</span>,</span>
<span>             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span>,</span>
<span>             shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             alpha<span class="op">=</span><span class="fl">0.5</span>, size <span class="op">=</span> <span class="fl">2</span>, stroke <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_function.html" class="external-link">geom_function</a></span><span class="op">(</span>fun<span class="op">=</span><span class="va">analytic_solution</span>, args<span class="op">=</span><span class="va">true_args_list</span>,</span>
<span>                colour<span class="op">=</span><span class="st">"black"</span>,</span>
<span>                linetype <span class="op">=</span> <span class="st">"solid"</span>,</span>
<span>                linewidth<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_shape_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">legend_spec_with_true</span><span class="op">$</span><span class="va">shapes</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_colour_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">legend_spec_with_true</span><span class="op">$</span><span class="va">colours</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_linetype_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">legend_spec</span><span class="op">$</span><span class="va">linetypes</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Time"</span>, y <span class="op">=</span> <span class="st">"Y(t)"</span>, title <span class="op">=</span> <span class="st">"Small step size"</span>,</span>
<span>       colour <span class="op">=</span> <span class="st">"Parameters"</span>, </span>
<span>       shape <span class="op">=</span> <span class="st">"Parameters"</span>,</span>
<span>       linetype <span class="op">=</span> <span class="st">"Parameters"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"inside"</span>,</span>
<span>        legend.position.inside <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.7</span>, <span class="fl">0.4</span><span class="op">)</span>,</span>
<span>        legend.key.spacing.y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">2</span>, <span class="st">'mm'</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">compare_sizes_over_time_smallstep</span></span>
<span><span class="co">#&gt; Warning: Multiple drawing groups in `geom_function()`</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">‚Ñπ</span> Did you use the correct <span style="color: #00BB00;">group</span>, <span style="color: #00BB00;">colour</span>, or <span style="color: #00BB00;">fill</span> aesthetics?</span></span></code></pre></div>
<p><img src="here_be_dragons_files/figure-html/unnamed-chunk-12-1.png" width="700"></p>
<p>Here are two plots showing the ODEs and analytic solutions with the
bad estimates compared to the true parameter values. To plot the ODEs we
exploit the fact that they are straight lines rather than plotting the
functions properly.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Get asymptotic size</span></span>
<span><span class="va">step_size_mix_models_par_ests</span><span class="op">$</span><span class="va">Y_max</span> <span class="op">&lt;-</span> <span class="va">step_size_mix_models_par_ests</span><span class="op">$</span><span class="va">error_beta_0</span><span class="op">/</span><span class="va">step_size_mix_models_par_ests</span><span class="op">$</span><span class="va">error_beta_1</span></span>
<span></span>
<span><span class="co">#Build points for start and end of lines</span></span>
<span><span class="va">plot_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="op">(</span><span class="va">beta_0</span><span class="op">/</span><span class="va">beta_1</span><span class="op">)</span>, </span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">step_size_mix_models_par_ests</span><span class="op">)</span><span class="op">)</span>, </span>
<span>        <span class="va">step_size_mix_models_par_ests</span><span class="op">$</span><span class="va">Y_max</span><span class="op">)</span>,</span>
<span>  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">beta_0</span>, <span class="fl">0</span>, </span>
<span>        <span class="va">step_size_mix_models_par_ests</span><span class="op">$</span><span class="va">error_beta_0</span>, </span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">step_size_mix_models_par_ests</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  step_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"True pars"</span>, <span class="st">"True pars"</span>, </span>
<span>                <span class="va">step_size_mix_models_par_ests</span><span class="op">$</span><span class="va">step_size</span>, </span>
<span>                <span class="va">step_size_mix_models_par_ests</span><span class="op">$</span><span class="va">step_size</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Plot DEs </span></span>
<span><span class="va">error_de_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">plot_data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span>,<span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">step_size</span><span class="op">)</span>,</span>
<span>                linetype <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">step_size</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_colour_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">legend_spec</span><span class="op">$</span><span class="va">colours</span><span class="op">[</span><span class="fl">3</span><span class="op">:</span><span class="fl">1</span><span class="op">]</span>, <span class="st">"black"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_linetype_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">legend_spec</span><span class="op">$</span><span class="va">linetypes</span><span class="op">[</span><span class="fl">3</span><span class="op">:</span><span class="fl">1</span><span class="op">]</span>, <span class="st">"solid"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"ODEs"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Y(t)"</span>, y <span class="op">=</span> <span class="st">"f"</span>, </span>
<span>       colour <span class="op">=</span> <span class="st">"Step size"</span>, </span>
<span>       linetype <span class="op">=</span> <span class="st">"Step size"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"inside"</span>,</span>
<span>        legend.position.inside <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.7</span>, <span class="fl">0.7</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">error_de_plot</span></span></code></pre></div>
<p><img src="here_be_dragons_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#Plot analytic solutions</span></span>
<span><span class="va">error_solution_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_function.html" class="external-link">geom_function</a></span><span class="op">(</span>fun<span class="op">=</span><span class="va">analytic_solution</span>, args<span class="op">=</span><span class="va">true_args_list</span>,</span>
<span>                  colour<span class="op">=</span><span class="st">"black"</span>, </span>
<span>                  linetype <span class="op">=</span> <span class="st">"solid"</span>,</span>
<span>                  linewidth<span class="op">=</span><span class="fl">1</span><span class="op">)</span> </span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">step_size_mix_models_par_ests</span><span class="op">)</span><span class="op">)</span><span class="op">{</span> <span class="co">#Add the analytic solutions</span></span>
<span>  <span class="va">args_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>pars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">step_size_mix_models_par_ests</span><span class="op">$</span><span class="va">error_beta_0</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>                           <span class="va">step_size_mix_models_par_ests</span><span class="op">$</span><span class="va">error_beta_1</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>                           <span class="va">true_y_0</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">error_solution_plot</span> <span class="op">&lt;-</span> <span class="va">error_solution_plot</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_function.html" class="external-link">geom_function</a></span><span class="op">(</span>fun<span class="op">=</span><span class="va">analytic_solution</span>, args<span class="op">=</span><span class="va">args_list</span>,</span>
<span>                  colour<span class="op">=</span><span class="va">legend_spec</span><span class="op">$</span><span class="va">colours</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>                  linetype <span class="op">=</span> <span class="va">legend_spec</span><span class="op">$</span><span class="va">linetypes</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>                  linewidth<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">error_solution_plot</span> <span class="op">&lt;-</span> <span class="va">error_solution_plot</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">legend_spec_with_true</span>,</span>
<span>            linewidth<span class="op">=</span><span class="fl">1</span>,</span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="va">fancy_name_no_step_size</span>,</span>
<span>                linetype <span class="op">=</span> <span class="va">fancy_name_no_step_size</span>,</span>
<span>                x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_colour_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">legend_spec_with_true</span><span class="op">$</span><span class="va">colours</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, </span>
<span>                                 <span class="va">legend_spec</span><span class="op">$</span><span class="va">colours</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">1</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_linetype_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">legend_spec_with_true</span><span class="op">$</span><span class="va">linetypes</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, </span>
<span>                                   <span class="va">legend_spec</span><span class="op">$</span><span class="va">linetypes</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">1</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">max_time</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="va">true_y_0</span>, <span class="op">(</span><span class="va">beta_0</span><span class="op">/</span><span class="va">beta_1</span><span class="op">+</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Time"</span>, y <span class="op">=</span> <span class="st">"Y(t)"</span>, </span>
<span>       title <span class="op">=</span> <span class="st">"Analytic solutions"</span>,</span>
<span>       colour <span class="op">=</span> <span class="st">"Parameters"</span>, </span>
<span>       linetype <span class="op">=</span> <span class="st">"Parameters"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"inside"</span>,</span>
<span>        legend.position.inside <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.7</span>, <span class="fl">0.4</span><span class="op">)</span>,</span>
<span>        legend.key.spacing.y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">2</span>, <span class="st">'mm'</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">error_solution_plot</span></span>
<span><span class="co">#&gt; Warning: Removed 4 rows containing missing values or values outside the scale range</span></span>
<span><span class="co">#&gt; (`geom_line()`).</span></span></code></pre></div>
<p><img src="here_be_dragons_files/figure-html/unnamed-chunk-13-2.png" width="700">
The limiting behaviour at
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Œ≤</mi><mn>0</mn></msub><mi>/</mi><msub><mi>Œ≤</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">\beta_0/\beta_1</annotation></semantics></math>
is consistent, what changes is how fast line approaches the
asymptote.</p>
</div>
</div>
<div class="section level2">
<h2 id="where-to-from-here">Where to from here?<a class="anchor" aria-label="anchor" href="#where-to-from-here"></a>
</h2>
<p>For the purpose of the hmde package that this vignette is a part of,
we account for the pathologies in this particular model by using the
analytic solution for the von Bertalanffy equation. More work needs to
be done to understand the interaction between numerical methods and MCMC
sampling. What we have demonstrated is that the problem exists, and it
is not enough to have numerical stability at the true parameter values
because MCMC estimation moves around, you need numerical stability in a
potentially quite large part of the parameter space. The good news is
that simulated data and posterior plots with more accurate numerical
methods can at least identify that something is going wrong.</p>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-butcher2016numerical" class="csl-entry">
Butcher, John Charles. 2016. <em>Numerical Methods for Ordinary
Differential Equations</em>. Third. John Wiley &amp; Sons.
</div>
<div id="ref-obrien2024allindividuals" class="csl-entry">
O‚ÄôBrien, Tess, David Warton, and Daniel Falster. 2024. <span>‚ÄúYes,
They‚Äôre All Individuals: Hierarchical Models for Repeat Survey Data
Improve Estimates of Tree Growth and Sie.‚Äù</span> <em>Methods in Ecology
and Evolution</em>.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Daniel Falster, Tess O‚ÄôBrien, David Warton.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer>
</div>





  </body>
</html>
