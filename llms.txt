# hmde ![](reference/figures/hmde_hex.png)

The goal of hmde is to fit a model for the rate of change in some
quantity based on a set of pre-defined functions arising from ecological
applications. We estimate differential equation parameters from repeated
observations of a process, such as growth rate parameters to data of
sizes over time. In other language, `hmde` implements hierarchical
Bayesian longitudinal models to solve the Bayesian inverse problem of
estimating differential equation parameters based on repeat measurement
surveys. Estimation is done using Markov Chain Monte Carlo, implemented
through [Stan](https://mc-stan.org/) via
[RStan](https://mc-stan.org/users/interfaces/rstan), built under
[R](https://cran.r-project.org/) 4.3.3. The inbuilt models are based on
case studies in ecology.

A pre-print paper is available on
[bioarXiv](https://doi.org/10.1101/2025.01.15.633280), or as the
[hmde_paper.pdf](https://github.com/traitecoevo/hmde/blob/master/inst/article/hmde_paper.pdf)
file here.

## The Maths

The general use case is to estimate a vector of parameters $\theta$ for
a chosen differential equation
$$f\left( Y(t),\theta \right) = \frac{dY}{dt}$$ based on the
longitudinal structure
$$Y\left( t_{j + 1} \right) = Y\left( t_{j} \right) + \int_{t_{j}}^{t_{j + 1}}f\left( Y(t),\theta \right)\, dt.$$

The input data are observations of the form $y_{ij}$ for individual $i$
at time $t_{j}$, with repeated observations coming from the same
individual. We parameterise $f$ at the individual level by estimating
$\theta_{i}$ as the vector of parameters. We have hyper-parameters that
determine the distribution of $\theta_{i}$ with typical prior
distribution
$$\theta_{i} \sim \log\mathcal{N}\left( \mu_{\log{(\theta)}},\sigma_{\log{(\theta)}} \right),$$
where $\mu_{\log{(\theta)}}$ and $\sigma_{\log{(\theta)}}$ are vectors
of means and standard deviations. In the case of a single individual,
these are chosen prior values. In the case of a multi-individual model
$\mu_{\log{(\theta)}}$ and $\sigma_{\log{(\theta)}}$ have their own
prior distributions and are fit to data.

## Implemented Models

`hmde` comes with four DEs built and ready to go, each of which has a
version for a single individual and multiple individuals.

### Constant Model

The constant model is given by
$$f\left( Y(t),\beta \right) = \frac{dY}{dt} = \beta,$$ and is best
understood as describing the average rate of change over time.

### von Bertalanffy

The von Bertalanffy mode is given by
$$f\left( Y(t),\beta,Y_{max} \right) = \frac{dY}{dt} = \beta\left( Y_{max} - Y(t) \right),$$
where $\beta$ is the growth rate parameter and $Y_{max}$ is the maximum
value that $Y$ takes.

### Canham

The Canham ([Canham et
al. 2004](https://doi.org/10.1890/1051-0761(2006)016%5B0540:NAOCTC%5D2.0.CO;2))
model is a hump-shaped function given by
$$f\left( Y(t),f_{max},Y_{max},k \right) = \frac{dY}{dt} = f_{max}\exp( - \frac{1}{2}(\frac{\ln\left( Y(t)/Y_{max} \right)}{k})^{2}),$$
where $f_{max}$ is the maximum growth rate, $Y_{max}$ is the $Y$-value
at which that maximum occurs, and $k$ controls how narrow or wide the
peak is.

## Installation

‘hmde’ is under active development. You can install the current
developmental version of ‘hmde’ from [GitHub](https://github.com/) with:

``` r
# install.packages("remotes")
remotes::install_github("traitecoevo/hmde")
```

## Quick demo

Create constant growth data with measurement error:

``` r
library(hmde)
y_obs <- seq(from=2, to=15, length.out=10) + rnorm(10, 0, 0.1)
```

Measurement error is necessary as otherwise the normal likelihood
$$s_{ij} \sim \mathcal{N}\left( 0,\sigma_{e} \right)$$ blows up as
$\sigma_{e}$ approaches 0.

Fit the model:

``` r
constant_fit <- hmde_model("constant_single_ind") |>
        hmde_assign_data(n_obs = 10,                  #Integer
                         y_obs = y_obs,               #vector length n_obs
                         obs_index = 1:10,            #vector length n_obs
                         time = 0:9,                  #Vector length n_obs
                         y_0_obs = y_obs[1]           #Real
        ) |>
        hmde_run(chains = 1, iter = 1000, verbose = FALSE, show_messages = FALSE)
```

## Found a bug?

Please submit a [GitHub
issue](https://github.com/traitecoevo/hmde/issues) with details of the
bug. A [reprex](https://reprex.tidyverse.org/) would be particularly
helpful with the bug-proofing process!

# Package index

## All functions

- [`Lizard_Size_Data`](https://traitecoevo.github.io/hmde/reference/Lizard_Size_Data.md)
  : Skink size data - Lampropholis delicata
- [`Tree_Size_Data`](https://traitecoevo.github.io/hmde/reference/Tree_Size_Data.md)
  : Garcinia recondita - Barro Colorado Island data
- [`Tree_Size_Ests`](https://traitecoevo.github.io/hmde/reference/Tree_Size_Ests.md)
  : Garcinia recondita model estimates - Barro Colorado Island data
- [`Trout_Size_Data`](https://traitecoevo.github.io/hmde/reference/Trout_Size_Data.md)
  : SUSTAIN Salmo trutta data
- [`hmde-package`](https://traitecoevo.github.io/hmde/reference/hmde-package.md)
  [`hmde`](https://traitecoevo.github.io/hmde/reference/hmde-package.md)
  : The 'hmde' package.
- [`hmde_affine_de()`](https://traitecoevo.github.io/hmde/reference/hmde_affine_de.md)
  : Differential equation for affine growth single individual model
- [`hmde_assign_data()`](https://traitecoevo.github.io/hmde/reference/hmde_assign_data.md)
  : Assign data to template for chosen model
- [`hmde_canham_de()`](https://traitecoevo.github.io/hmde/reference/hmde_canham_de.md)
  : Differential equation for Canham growth single and multi- individual
  models
- [`hmde_const_de()`](https://traitecoevo.github.io/hmde/reference/hmde_const_de.md)
  : Differential equation for constant growth single and multi-
  individual models
- [`hmde_extract_Rhat()`](https://traitecoevo.github.io/hmde/reference/hmde_extract_Rhat.md)
  : Calculate Rhat statistics for a hmde_fit object
- [`hmde_extract_estimates()`](https://traitecoevo.github.io/hmde/reference/hmde_extract_estimates.md)
  : Extract samples and return measurement, individual, and
  population-level estimates
- [`hmde_model()`](https://traitecoevo.github.io/hmde/reference/hmde_model.md)
  : Select data configuration template for hmde supported model
- [`hmde_model_des()`](https://traitecoevo.github.io/hmde/reference/hmde_model_des.md)
  : Function to select DE given model name
- [`hmde_model_names()`](https://traitecoevo.github.io/hmde/reference/hmde_model_names.md)
  : Returns names of available models.
- [`hmde_model_pars()`](https://traitecoevo.github.io/hmde/reference/hmde_model_pars.md)
  : Show parameter list for hmde supported model
- [`hmde_plot_Rhat_hist()`](https://traitecoevo.github.io/hmde/reference/hmde_plot_Rhat_hist.md)
  : Plot histogram of R_hat values for hmde_fit object.
- [`hmde_plot_de_pieces()`](https://traitecoevo.github.io/hmde/reference/hmde_plot_de_pieces.md)
  : Plot pieces of chosen differential equation model for each
  individual. Structured to take the individual data tibble that is
  built by the hmde_extract_estimates function using the
  ind_par_name_mean estimates. Function piece will go from the first
  fitted size to the last. Accepted ggplot arguments will change the
  axis labels, title, line colour, alpha
- [`hmde_plot_obs_est_inds()`](https://traitecoevo.github.io/hmde/reference/hmde_plot_obs_est_inds.md)
  : Plot estimated and observed values over time for a chosen number of
  individuals based on posterior estimates. Structured to take in the
  measurement_data tibble constructed by the hmde_extract_estimates
  function.
- [`hmde_run()`](https://traitecoevo.github.io/hmde/reference/hmde_run.md)
  : Run chosen pre-built model in Stan
- [`hmde_vb_de()`](https://traitecoevo.github.io/hmde/reference/hmde_vb_de.md)
  : Differential equation for von Bertalanffy growth single and multi-
  individual models
- [`plot(`*`<hmde_model_template>`*`)`](https://traitecoevo.github.io/hmde/reference/plot.hmde_model_template.md)
  : Plot function for hmde_model_template object
- [`print(`*`<hmde_model_template>`*`)`](https://traitecoevo.github.io/hmde/reference/print.hmde_model_template.md)
  : Print function for hmde_model_template object
- [`summary(`*`<hmde_model_template>`*`)`](https://traitecoevo.github.io/hmde/reference/summary.hmde_model_template.md)
  : Summary function for hmde_model_template object

# Articles

### All vignettes

- [Case study 3: Canham function growth with tree data from Barro
  Colorado
  Island](https://traitecoevo.github.io/hmde/articles/canham.md):
- [Case study 1: Constant growth with SUSTAIN Trout
  data](https://traitecoevo.github.io/hmde/articles/constant-growth.md):
- [Here be
  dragons](https://traitecoevo.github.io/hmde/articles/here_be_dragons.md):
- [hmde for
  Mathematicians](https://traitecoevo.github.io/hmde/articles/hmde_for_mathematicians.md):
- [hmde](https://traitecoevo.github.io/hmde/articles/hmde.md):
- [Case study 2: von Bertalanffy growth with lizard size
  data](https://traitecoevo.github.io/hmde/articles/von-bertalanffy.md):
